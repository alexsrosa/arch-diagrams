@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

LAYOUT_LEFT_RIGHT()
TITLE Stateless Microservices with Persistent Storage

Person(user, "User", "Uses a web browser")

System_Boundary(k8s_cluster, "Kubernetes Cluster") {
  System_Boundary(gateway_ns, "Gateway Namespace") {
    Container(ingress, "Ingress Controller", "Nginx Ingress", "External traffic entry point")
    Container(api_gateway, "API Gateway", "Kong\nStateless Pod", "Routes API requests")
  }
  
  System_Boundary(services_ns, "Services Namespace") {
    Container(user_svc, "User Service", "ClusterIP", "User management")
    Container(user_pods, "User Pods", "Java, Spring Boot\nStateless Pods (3 replicas)", "Handles user operations")
    
    Container(product_svc, "Product Service", "ClusterIP", "Product catalog")
    Container(product_pods, "Product Pods", "Java, Spring Boot\nStateless Pods (3 replicas)", "Manages products")
    
    Container(order_svc, "Order Service", "ClusterIP", "Order processing")
    Container(order_pods, "Order Pods", "Java, Spring Boot\nStateless Pods (2 replicas)", "Processes orders")
  }
  
  System_Boundary(storage_ns, "Storage Namespace") {
    Container(pv, "Persistent Volume", "Kubernetes PV", "Cluster-wide storage")
    Container(pvc, "Persistent Volume Claim", "Kubernetes PVC", "Storage request")
    ContainerDb(db_pod, "Database Pod", "PostgreSQL\nStateful Pod", "Shared database with persistent storage")
  }
  
  System_Boundary(config_ns, "Config Namespace") {
    Container(configmap, "ConfigMap", "Kubernetes ConfigMap", "Application configuration")
    Container(secrets, "Secrets", "Kubernetes Secrets", "Database credentials")
  }
}

Rel(user, ingress, "Accesses via", "HTTP/HTTPS")
Rel(ingress, api_gateway, "Routes requests", "HTTP")
Rel(api_gateway, user_svc, "User requests", "HTTP")
Rel(api_gateway, product_svc, "Product requests", "HTTP")
Rel(api_gateway, order_svc, "Order requests", "HTTP")
Rel(user_svc, user_pods, "Load balances", "HTTP")
Rel(product_svc, product_pods, "Load balances", "HTTP")
Rel(order_svc, order_pods, "Load balances", "HTTP")
Rel(user_pods, db_pod, "User data", "JDBC/SQL")
Rel(product_pods, db_pod, "Product data", "JDBC/SQL")
Rel(order_pods, db_pod, "Order data", "JDBC/SQL")
Rel(db_pod, pvc, "Uses storage", "File System")
Rel(pvc, pv, "Claims storage", "Storage API")
Rel(user_pods, configmap, "Reads config", "K8s API")
Rel(product_pods, configmap, "Reads config", "K8s API")
Rel(order_pods, configmap, "Reads config", "K8s API")
Rel(db_pod, secrets, "Reads credentials", "K8s API")
@enduml